<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Persistencia de Transacciones - SmartBudget</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .test-container { max-width: 800px; margin: 2rem auto; padding: 2rem; }
        .test-section { margin-bottom: 2rem; padding: 1.5rem; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .json-output { background: #f8f9fa; padding: 1rem; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .status { padding: 0.5rem; margin: 0.5rem 0; border-radius: 4px; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .form-row { margin-bottom: 1rem; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="text-center mb-4">ğŸ§ª Test de Persistencia de Transacciones</h1>
        
        <!-- Test de Persistencia -->
        <div class="test-section">
            <h3>ğŸ“ Crear Nueva TransacciÃ³n</h3>
            <form id="transactionForm">
                <div class="form-row">
                    <div class="col-md-3">
                        <label>Tipo</label>
                        <select id="type" class="form-control">
                            <option value="ingreso">ğŸ’° Ingreso</option>
                            <option value="gasto">ğŸ’¸ Gasto</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>Monto</label>
                        <input type="number" id="amount" class="form-control" placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="col-md-4">
                        <label>DescripciÃ³n</label>
                        <input type="text" id="description" class="form-control" placeholder="Describe la transacciÃ³n" required>
                    </div>
                    <div class="col-md-2">
                        <label>&nbsp;</label>
                        <button type="submit" class="btn btn-primary btn-block">ğŸ’¾ Guardar</button>
                    </div>
                </div>
            </form>
            <div id="saveStatus"></div>
        </div>

        <!-- Estado de la Base de Datos -->
        <div class="test-section">
            <h3>ğŸ“Š Estado de la Base de Datos</h3>
            <div class="row">
                <div class="col-md-6">
                    <button id="loadTransactions" class="btn btn-info btn-block">ğŸ”„ Cargar Transacciones</button>
                </div>
                <div class="col-md-6">
                    <button id="clearStorage" class="btn btn-warning btn-block">ğŸ—‘ï¸ Limpiar LocalStorage</button>
                </div>
            </div>
            
            <div id="dbStatus" class="mt-3"></div>
            <div id="transactionsOutput" class="json-output mt-2"></div>
        </div>

        <!-- SimulaciÃ³n de JSON -->
        <div class="test-section">
            <h3>ğŸ”§ SimulaciÃ³n de Archivo JSON</h3>
            <p><small>Simulamos lo que se escribirÃ­a al archivo transactions.json</small></p>
            <div id="jsonSimulation" class="json-output"></div>
        </div>

        <!-- Resumen de Pruebas -->
        <div class="test-section">
            <h3>ğŸ“ˆ Resumen de Pruebas</h3>
            <ul id="testSummary" class="list-group">
                <li class="list-group-item">âœ… Formulario de transacciÃ³n funcional</li>
                <li class="list-group-item">âœ… ValidaciÃ³n de campos requeridos</li>
                <li class="list-group-item">âœ… Persistencia en localStorage</li>
                <li class="list-group-item">âœ… GeneraciÃ³n de ID Ãºnico automÃ¡tico</li>
                <li class="list-group-item">âœ… Timestamp automÃ¡tico</li>
                <li class="list-group-item">âœ… SimulaciÃ³n de escritura JSON</li>
            </ul>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // SimulaciÃ³n de datos existentes para testing
        const EXISTING_TRANSACTIONS = [
            {
                id: 1,
                userId: 2,
                type: "ingreso",
                amount: 3200.00,
                description: "Salario mensual enero",
                date: "2026-01-15"
            },
            {
                id: 2,
                userId: 2,
                type: "gasto",
                amount: 45.50,
                description: "Compras semanales",
                date: "2026-01-20"
            },
            {
                id: 13,
                userId: 2,
                type: "gasto",
                amount: 89.99,
                description: "Internet mensual",
                date: "2026-01-24"
            }
        ];

        // Usuario actual (simulado desde login)
        const currentUser = {
            id: 2,
            username: "maria.gonzalez@email.com",
            name: "MarÃ­a GonzÃ¡lez"
        };

        class TransactionPersistence {
            constructor() {
                this.STORAGE_KEY = 'smartbudget_transactions';
                this.initializeStorage();
            }

            initializeStorage() {
                const existing = localStorage.getItem(this.STORAGE_KEY);
                if (!existing) {
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(EXISTING_TRANSACTIONS));
                    this.updateStatus('Initialized with test data', 'success');
                }
            }

            async saveTransaction(transactionData) {
                try {
                    // Generar nuevo ID
                    const transactions = this.getAllTransactions();
                    const newId = Math.max(...transactions.map(t => t.id), 0) + 1;

                    // Crear nueva transacciÃ³n
                    const newTransaction = {
                        id: newId,
                        userId: currentUser.id,
                        type: transactionData.type,
                        amount: parseFloat(transactionData.amount),
                        description: transactionData.description,
                        date: new Date().toISOString().split('T')[0]
                    };

                    // Agregar a la lista
                    transactions.push(newTransaction);

                    // Guardar en localStorage
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(transactions));

                    // Simular escritura al archivo JSON
                    this.simulateJSONWrite(transactions);

                    // Mostrar confirmaciÃ³n
                    this.updateStatus(`âœ… TransacciÃ³n guardada con ID: ${newId}`, 'success');
                    this.logTransaction(newTransaction);

                    return { success: true, transaction: newTransaction, totalCount: transactions.length };

                } catch (error) {
                    this.updateStatus(`âŒ Error: ${error.message}`, 'error');
                    return { success: false, error: error.message };
                }
            }

            getAllTransactions() {
                const stored = localStorage.getItem(this.STORAGE_KEY);
                return stored ? JSON.parse(stored) : [];
            }

            getUserTransactions(userId = currentUser.id) {
                return this.getAllTransactions().filter(t => t.userId === userId);
            }

            simulateJSONWrite(transactions) {
                const jsonContent = JSON.stringify(transactions, null, 2);
                document.getElementById('jsonSimulation').textContent = jsonContent;
                console.log('ğŸ“ Contenido que se escribirÃ­a a transactions.json:', jsonContent);
            }

            updateStatus(message, type) {
                const statusEl = document.getElementById('saveStatus');
                statusEl.innerHTML = `<div class="status ${type}">${message}</div>`;
                
                setTimeout(() => {
                    statusEl.innerHTML = '';
                }, 3000);
            }

            logTransaction(transaction) {
                console.log('ğŸ†• Nueva transacciÃ³n creada:', transaction);
                console.log(`ğŸ“Š Total transacciones en base: ${this.getAllTransactions().length}`);
                console.log(`ğŸ‘¤ Transacciones del usuario ${currentUser.name}: ${this.getUserTransactions().length}`);
            }

            clearStorage() {
                localStorage.removeItem(this.STORAGE_KEY);
                this.updateStatus('ğŸ—‘ï¸ Storage limpiado', 'success');
                document.getElementById('transactionsOutput').textContent = '';
                document.getElementById('jsonSimulation').textContent = '';
            }
        }

        // Inicializar sistema
        const persistence = new TransactionPersistence();

        // Event Listeners
        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                type: document.getElementById('type').value,
                amount: document.getElementById('amount').value,
                description: document.getElementById('description').value
            };

            // Validar datos
            if (!formData.amount || !formData.description.trim()) {
                persistence.updateStatus('âŒ Faltan datos requeridos', 'error');
                return;
            }

            // Guardar transacciÃ³n
            const result = await persistence.saveTransaction(formData);
            
            if (result.success) {
                // Limpiar formulario
                document.getElementById('transactionForm').reset();
                
                // Actualizar visualizaciÃ³n
                loadAndDisplayTransactions();
                
                // Mostrar resultado
                persistence.updateStatus(
                    `âœ… TransacciÃ³n guardada! Total en base: ${result.totalCount}`, 
                    'success'
                );
            }
        });

        document.getElementById('loadTransactions').addEventListener('click', loadAndDisplayTransactions);

        document.getElementById('clearStorage').addEventListener('click', () => {
            if (confirm('Â¿Seguro que quieres limpiar todas las transacciones?')) {
                persistence.clearStorage();
                loadAndDisplayTransactions();
            }
        });

        function loadAndDisplayTransactions() {
            const allTransactions = persistence.getAllTransactions();
            const userTransactions = persistence.getUserTransactions();
            
            // Mostrar estadÃ­sticas
            document.getElementById('dbStatus').innerHTML = `
                <div class="row">
                    <div class="col-md-4 text-center">
                        <h4 class="text-primary">${allTransactions.length}</h4>
                        <small>Total Transacciones</small>
                    </div>
                    <div class="col-md-4 text-center">
                        <h4 class="text-success">${userTransactions.length}</h4>
                        <small>Del Usuario Actual</small>
                    </div>
                    <div class="col-md-4 text-center">
                        <h4 class="text-info">${userTransactions.filter(t => t.type === 'ingreso').length}</h4>
                        <small>Ingresos</small>
                    </div>
                </div>
            `;

            // Mostrar transacciones del usuario
            const output = userTransactions.map(t => 
                `ID: ${t.id} | ${t.type.toUpperCase()} | $${t.amount} | ${t.description} | ${t.date}`
            ).join('\n');

            document.getElementById('transactionsOutput').textContent = 
                output || 'No hay transacciones del usuario actual';

            // Actualizar simulaciÃ³n JSON
            persistence.simulateJSONWrite(allTransactions);
        }

        // Cargar datos iniciales
        loadAndDisplayTransactions();

        // Test inicial automÃ¡tico
        setTimeout(() => {
            console.log('ğŸš€ Sistema de persistencia inicializado');
            console.log('ğŸ’¾ Storage key:', persistence.STORAGE_KEY);
            console.log('ğŸ‘¤ Usuario actual:', currentUser);
            console.log('ğŸ“¦ Transacciones cargadas:', persistence.getAllTransactions().length);
        }, 500);
    </script>
</body>
</html>